# Generated by Chef for <%= node[:fqdn] %>
# Local modifications will be overwritten.
<VirtualHost *:<%= @params[:listen_port] %>>

    ServerName <%= @params[:server_name] %>
    ServerAlias <% @params[:server_aliases].each do |a| %><%= "#{a}" %> <% end %>
    DocumentRoot <%= @params[:docroot] %>
    UseCanonicalName Off
    RewriteEngine On
    ExpiresActive On
    TraceEnable Off

    <% if @params[:deflate_enabled] %>
    <IfModule mod_deflate.c>
        SetOutputFilter DEFLATE

        <IfModule mod_setenvif.c>
            # Netscape 4.x has some problems
            BrowserMatch ^Mozilla/4 gzip-only-text/html

            # Netscape 4.06-4.08 have some more problems
            BrowserMatch ^Mozilla/4\.0[678] no-gzip

            # MSIE masquerades as Netscape, but it is fine
            BrowserMatch \bMSIE !no-gzip !gzip-only-text/html

            # Don't compress already-compressed files
            SetEnvIfNoCase Request_URI .(?:gif|jpe?g|png)$ no-gzip dont-vary
            SetEnvIfNoCase Request_URI .(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
            SetEnvIfNoCase Request_URI .(?:avi|mov|mp3|mp4|rm|flv|swf|mp?g)$ no-gzip dont-vary
            SetEnvIfNoCase Request_URI .pdf$ no-gzip dont-vary
        </IfModule>

        <IfModule mod_headers.c>
            # Make sure proxies don't deliver the wrong content
            Header append Vary User-Agent env=!dont-vary
        </IfModule>
    </IfModule>
    <% end %>

    <% if @params[:ssl_enabled] %>
    SSLEngine on
    SSLOptions +StrictRequire

    <Directory />
        SSLRequireSSL
    </Directory>

    SSLProtocol -all +TLSv1 +SSLv3
    SSLCipherSuite HIGH:MEDIUM:!aNULL:+SHA1:+MD5:+HIGH:+MEDIUM

    SSLCertificateFile <%= @params[:ssl_cert_file] %>
    SSLCertificateKeyFile <%= @params[:ssl_key_file] %>
    SSLVerifyClient none
    SSLProxyEngine off

    <IfModule mime.c>
        AddType application/x-x509-ca-cert      .crt
        AddType application/x-pkcs7-crl         .crl
    </IfModule>
    <% end %>

    <% unless @params[:enable_etag] %>
    <IfModule mod_headers.c>
        Header unset ETag
    </IfModule>
    FileETag None
    <% end %>

    <% if @params[:enable_ie_header] %>
    <FilesMatch "\.(html|htm)$">
        <IfModule mod_headers.c>
            Header set X-UA-Compatible "IE=9; IE=8; IE=7; IE=EDGE"
        </IfModule>
    </FilesMatch>
    <% end %>

    <% @params[:rewrites].each do |rule| %>
    <%= rule %>
    <% end %>

    <% @params[:aem_locations].each do |dir| %>
    <Directory <%= dir %>>
        <IfModule disp_apache2.c>
            SetHandler dispatcher-handler
            ModMimeUsePathInfo On
        </IfModule>
        <IfModule mod_include.c>
            SetOutputFilter INCLUDES
        </IfModule>
    </Directory>
    <% end %>

    <Directory "<%= @params[:docroot] %>">
        <IfModule mod_include.c>
            Options Indexes FollowSymLinks Includes
        </IfModule>
        <IfModule !mod_include.c>
            Options Indexes FollowSymLinks
        </IfModule>
        AllowOverride None
        Require all granted
    </Directory>

    <% @params[:expire_dirs].each do |dir| %>
    <Location <%= dir[:path] %>>
        <% dir[:rules].each do |rule| %>
        <%= rule %>
        <% end %>
    </Location>
    <% end %>

    <Location /server-status>
        SetHandler server-status
        Require local
    </Location>

    DirectoryIndex index.html index.html.var

    LogLevel info rewrite:trace1

    ErrorLog <%= node[:apache][:log_dir] %>/<%= @params[:name] %>-error.log
    CustomLog <%= node[:apache][:log_dir] %>/<%= @params[:name] %>-access.log combined

    <% @params[:header].each do |head| %>
    <%= head %>
    <% end %>

</VirtualHost>
